---
- name: Zabbix Agent2 kurulum + sabit conf kopyalama + status kontrol
  hosts: zabbix_clients
  become: yes
  gather_facts: yes

  vars:
    # Ubuntu 20.04 için Zabbix 6.0 repo paketi
    zabbix_repo_deb_ubuntu20: "https://repo.zabbix.com/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.0-1+ubuntu20.04_all.deb"

    # Ubuntu 22.04 için Zabbix 7.0 repo paketi (ileride ihtiyaç olursa)
    zabbix_repo_deb_ubuntu22: "https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-2+ubuntu22.04_all.deb"

    zabbix_agent_pkg: "zabbix-agent2"
    zabbix_agent_service: "zabbix-agent2"
    zabbix_agent_service_unit: "zabbix-agent2.service"

  tasks:
    - name: OS bilgisini göster
      ansible.builtin.debug:
        msg: "OS: {{ ansible_facts.distribution }} {{ ansible_facts.distribution_version }}"

    - name: Uygun Zabbix repo URL'sini seç
      ansible.builtin.set_fact:
        zabbix_repo_deb: >-
          {% if ansible_facts.distribution == "Ubuntu" and ansible_facts.distribution_version is search("^20\.04") %}
          {{ zabbix_repo_deb_ubuntu20 }}
          {% elif ansible_facts.distribution == "Ubuntu" and ansible_facts.distribution_version is search("^22\.04") %}
          {{ zabbix_repo_deb_ubuntu22 }}
          {% else %}
          {{ zabbix_repo_deb_ubuntu20 }}
          {% endif %}

    - name: Kurulu paketleri oku
      ansible.builtin.package_facts:
        manager: auto

    - name: Agent2 zaten kurulu mesajı
      ansible.builtin.debug:
        msg: "Zabbix Agent2 zaten kurulu"
      when: zabbix_agent_pkg in ansible_facts.packages

    - name: Agent2 yoksa repo + kurulum yap
      block:
        - name: Zabbix repo paketini kur (Ubuntu/Debian)
          ansible.builtin.apt:
            deb: "{{ zabbix_repo_deb }}"
            state: present
          when: ansible_facts.os_family == "Debian"

        - name: apt cache güncelle
          ansible.builtin.apt:
            update_cache: yes
          when: ansible_facts.os_family == "Debian"

        - name: Zabbix Agent2 paketini kur
          ansible.builtin.package:
            name: "{{ zabbix_agent_pkg }}"
            state: present
      when: zabbix_agent_pkg not in ansible_facts.packages

    - name: Hazırladığın zabbix_agent2.conf dosyasını kopyala
      ansible.builtin.copy:
        src: "zabbix_agent2.conf"
        dest: "/etc/zabbix/zabbix_agent2.conf"
        owner: root
        group: root
        mode: "0644"

    - name: Servisi enable + restart et
      ansible.builtin.systemd:
        name: "{{ zabbix_agent_service }}"
        enabled: yes
        state: restarted

    - name: Servis bilgilerini al
      ansible.builtin.service_facts:

    - name: Servis running mi kontrol et
      ansible.builtin.assert:
        that:
          - zabbix_agent_service_unit in ansible_facts.services
          - ansible_facts.services[zabbix_agent_service_unit].state == 'running'
        fail_msg: "HATA: {{ inventory_hostname }} üzerinde Zabbix Agent2 RUNNING değil"
        success_msg: "OK: {{ inventory_hostname }} üzerinde Zabbix Agent2 RUNNING"
