---
- name: Zabbix Agent2 kurulum + conf kopyalama + status kontrol
  hosts: zabbix_clients
  become: yes
  gather_facts: yes

  vars:
    # Ubuntu 20.04 → Zabbix 6.0 repo
    zabbix_repo_deb_ubuntu20: "https://repo.zabbix.com/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_6.0+ubuntu20.04_all.deb"

    # Ubuntu 22.04 → Zabbix 7.0 repo
    zabbix_repo_deb_ubuntu22: "https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-2+ubuntu22.04_all.deb"

    zabbix_agent_pkg: "zabbix-agent2"
    zabbix_agent_service: "zabbix-agent2"
    zabbix_agent_service_unit: "zabbix-agent2.service"

  tasks:

    # OS bilgisi
    - name: OS bilgisini göster
      ansible.builtin.debug:
        msg: "OS: {{ ansible_facts.distribution }} {{ ansible_facts.distribution_version }}"

    # Doğru Zabbix repo .deb URL'sini seç
    - name: Uygun repo URL'sini belirle
      ansible.builtin.set_fact:
        zabbix_repo_deb: >-
          {% if ansible_facts.distribution_version is search("^20\.04") %}
          {{ zabbix_repo_deb_ubuntu20 }}
          {% elif ansible_facts.distribution_version is search("^22\.04") %}
          {{ zabbix_repo_deb_ubuntu22 }}
          {% else %}
          {{ zabbix_repo_deb_ubuntu20 }}
          {% endif %}

    # Mevcut paket listesini oku
    - name: Kurulu paketleri oku
      ansible.builtin.package_facts:
        manager: auto

    # Agent zaten kuruluysa bilgi ver
    - name: Agent2 zaten kurulu mesajı
      ansible.builtin.debug:
        msg: "Zabbix Agent2 zaten kurulu!"
      when: zabbix_agent_pkg in ansible_facts.packages

    # Agent yoksa repo + kurulum
    - name: Agent2 yoksa repo + kurulum yap
      block:

        - name: Zabbix repo .deb indir
          ansible.builtin.get_url:
            url: "{{ zabbix_repo_deb }}"
            dest: "/tmp/zabbix-release.deb"
            mode: "0644"

        - name: Repo paketini dpkg ile kur
          ansible.builtin.command: "dpkg -i /tmp/zabbix-release.deb"

        - name: apt cache güncelle (postgres repo hatalarını yok say)
          ansible.builtin.apt:
            update_cache: yes
          ignore_errors: yes

        - name: Zabbix Agent2 paketini kur
          ansible.builtin.package:
            name: "{{ zabbix_agent_pkg }}"
            state: present

      when: zabbix_agent_pkg not in ansible_facts.packages

    # Konfigürasyon dosyasını kopyala
    - name: zabbix_agent2.conf’ı kopyala
      ansible.builtin.copy:
        src: "zabbix_agent2.conf"
        dest: "/etc/zabbix/zabbix_agent2.conf"
        owner: root
        group: root
        mode: "0644"
      # YORUM: buralar düzenlenecek

    # Servisi enable + restart et
    - name: Servisi enable + restart et
      ansible.builtin.systemd:
        name: "{{ zabbix_agent_service }}"
        enabled: yes
        state: restarted

    # Servis bilgilerini oku
    - name: Servis bilgilerini oku
      ansible.builtin.service_facts:

    # Servis running mi kontrol et
    - name: Servis çalışıyor mu kontrol et
      ansible.builtin.assert:
        that:
          - zabbix_agent_service_unit in ansible_facts.services
          - ansible_facts.services[zabbix_agent_service_unit].state == "running"
        fail_msg: "HATA: {{ inventory_hostname }} üzerinde Zabbix Agent2 ÇALIŞMIYOR!"
        success_msg: "OK: {{ inventory_hostname }} üzerinde Zabbix Agent2 RUNNING!"
